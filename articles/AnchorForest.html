<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AnchorForest ‚Ä¢ SDModels</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="48x48" href="../favicon-48x48.png">
<link rel="icon" type="‚Äùimage/svg+xml‚Äù" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="AnchorForest">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">


    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">SDModels</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">1.0.13</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles

    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/AnchorForest.html">AnchorForest</a>
    </li>
    <li>
      <a href="../articles/Runtime.html">Runtime</a>
    </li>
    <li>
      <a href="../articles/SDAM.html">SDAM</a>
    </li>
    <li>
      <a href="../articles/SDForest.html">SDForest</a>
    </li>
    <li>
      <a href="../articles/SDTree.html">SDTree</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/markusul/SDModels/" class="external-link">
    <span class="fab fa-github fa-lg"></span>

  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->



      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>AnchorForest</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/markusul/SDModels/blob/main/vignettes/articles/AnchorForest.Rmd" class="external-link"><code>vignettes/articles/AnchorForest.Rmd</code></a></small>
      <div class="hidden name"><code>AnchorForest.Rmd</code></div>

    </div>

    
    
<hr>
<p>In the same spirit as the spectral objective, we can use this
software also to minimize the anchor loss <span class="citation">(Rothenh√§usler et al. 2021)</span>. Anchor Regression
is a regularized regression method providing robustness against
distribution shifts of environments. This is usefull, if one wants to
predict optimally in a worst case scenario. An example usecase could be
to predict health oucome of a patient based on their medical history
where a model is trained on a larger population of patients. Standard
regression methods would optimize the population performance, while
Anchor Regression would optimize for the worst case scenario, i.e.¬†the
patient with the most different medical history.</p>
<p>Here, we optimize the Anchor Random Forest using the anchor loss
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mover><mi>f</mi><mo accent="true">ÃÇ</mo></mover><mrow><mi>a</mi><mi>n</mi><mi>c</mi><mi>h</mi><mi>o</mi><mi>r</mi></mrow></msub><mo>=</mo><msub><mtext mathvariant="normal">argmin</mtext><mrow><mi>f</mi><mi>‚Ä≤</mi><mo>‚àà</mo><mi>‚Ñ±</mi></mrow></msub><mfrac><mrow><mrow><mo stretchy="true" form="prefix">|</mo><mo stretchy="true" form="postfix">|</mo></mrow><mi>W</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>ùêò</mi><mo>‚àí</mo><mi>f</mi><mi>‚Ä≤</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>ùêó</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">)</mo></mrow><msubsup><mrow><mo stretchy="true" form="prefix">|</mo><mo stretchy="true" form="postfix">|</mo></mrow><mn>2</mn><mn>2</mn></msubsup></mrow><mi>n</mi></mfrac></mrow><annotation encoding="application/x-tex">
\hat{f}_{anchor} = \text{argmin}_{f' \in \mathcal{F}} \frac{||W(\mathbf{Y} - f'(\mathbf{X}))||_2^2}{n}
</annotation></semantics></math> where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>W</mi><mo>=</mo><msub><mi>W</mi><mi>Œ≥</mi></msub><mo>=</mo><mi>I</mi><mo>‚àí</mo><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mo>‚àí</mo><msqrt><mi>Œ≥</mi></msqrt><mo stretchy="true" form="postfix">)</mo></mrow><msub><mi>Œ†</mi><mi>ùêÄ</mi></msub></mrow><annotation encoding="application/x-tex">W = W_{\gamma} = I - (1 - \sqrt{\gamma})\Pi_{\mathbf{A}}</annotation></semantics></math>
with
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>Œ†</mi><mi>ùêÄ</mi></msub><annotation encoding="application/x-tex">\Pi_{\mathbf{A}}</annotation></semantics></math>
being the linear projection operator onto
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>ùêÄ</mi><annotation encoding="application/x-tex">\mathbf{A}</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>Œ≥</mi><annotation encoding="application/x-tex">\gamma</annotation></semantics></math>
controlling the strength of distributional robustness <span class="citation">(B√ºhlmann 2020)</span>. Another approach would be to
boost the anchor loss instead of minimizing it explicitly which provides
a much faster approach but also more parameters to choose. Check out <a href="https://github.com/mlondschien/anchorboosting" class="external-link">anchorboosting</a>
<span class="citation">(Londschien et al. 2025)</span> for this
apporach. (We want to thank Malte Londschien for all the fruitful
discussions about the extension of Anchor Regression to non-linear
models.)</p>
<p>Below, we reproduce Figure 4 from <span class="citation">(Rothenh√§usler et al. 2021)</span> using the
Bike-sharing data set <span class="citation">(Markelle Kelly
2017)</span> and add the Anchor Random Forest to the comparison. The
goal is to predict the number of bike rentals based on the weather
conditions robustly over different days. So in contrast to standard
machine learning, we want to performe well on the most difficult day.
This is why we look at the quantiles of the prediction error conditional
on the day
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>ùîº</mi><mrow><mi>t</mi><mi>e</mi><mi>s</mi><mi>t</mi></mrow></msub><mrow><mo stretchy="true" form="prefix">[</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi>Y</mi><mo>‚àí</mo><mover><mi>f</mi><mo accent="true">ÃÇ</mo></mover><mrow><mo stretchy="true" form="prefix">(</mo><mi>X</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="false" form="prefix">|</mo><mtext mathvariant="normal">day</mtext><mo stretchy="true" form="postfix">]</mo></mrow></mrow><annotation encoding="application/x-tex">\mathbb{E}_{test}[(Y - \hat{f}(X))| \text{day}]</annotation></semantics></math>.
With stronger regularization (higher
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>Œ≥</mi><annotation encoding="application/x-tex">\gamma</annotation></semantics></math>),
we see upper quantiles of the prediction errors (the more difficult
days) decrease, while we lose performance on the easier days.</p>
<p><img src="bike.png" style="width:100.0%"></p>
<p>Looking at the performance of different quantiles, it seems
reasonable to use
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Œ≥</mi><mo>=</mo><mn>2</mn></mrow><annotation encoding="application/x-tex">\gamma = 2</annotation></semantics></math>
to have optimale ‚Äúworst case performance‚Äù. Below we show how you could
fit an Anchor Random Forest in this case. For that we first load the
data from <a href="https://archive.ics.uci.edu/dataset/275/bike+sharing+dataset" class="external-link uri">https://archive.ics.uci.edu/dataset/275/bike+sharing+dataset</a>
and preprocess it as in <span class="citation">(Rothenh√§usler et al.
2021)</span>.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># load data</span></span>
<span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span><span class="st">"hour.csv"</span><span class="op">)</span></span>
<span><span class="va">dframe</span> <span class="op">&lt;-</span> <span class="va">dat</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"dteday"</span>, <span class="st">"yr"</span>, <span class="st">"mnth"</span>, <span class="st">"holiday"</span>, <span class="st">"weekday"</span>, <span class="st">"workingday"</span>, </span>
<span>                  <span class="st">"weathersit"</span>, <span class="st">"temp"</span>, <span class="st">"atemp"</span>, <span class="st">"hum"</span>, <span class="st">"windspeed"</span>, <span class="st">"cnt"</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">dframe</span><span class="op">$</span><span class="va">cnt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/residuals.html" class="external-link">residuals</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">cnt</span><span class="op">)</span> <span class="op">~</span>  <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">holiday</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">weekday</span><span class="op">)</span>, </span>
<span>                           data <span class="op">=</span> <span class="va">dat</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>To have an out-of-environment performance estimate, we group the days
into five groups and estimate the Random Forest while leaving one group
out for testing.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># group days in five groups</span></span>
<span><span class="va">number_days</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">dframe</span><span class="op">$</span><span class="va">dteday</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">env</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">dframe</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">folds</span> <span class="op">&lt;-</span> <span class="fl">5</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">folds</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">selected_days</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">dframe</span><span class="op">$</span><span class="va">dteday</span><span class="op">)</span><span class="op">[</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">ceiling</a></span><span class="op">(</span><span class="op">(</span><span class="va">i</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">*</span><span class="va">number_days</span><span class="op">/</span><span class="va">folds</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">ceiling</a></span><span class="op">(</span><span class="va">i</span><span class="op">*</span><span class="va">number_days</span><span class="op">/</span><span class="va">folds</span><span class="op">)</span><span class="op">]</span></span>
<span>  <span class="va">env</span><span class="op">[</span><span class="va">dframe</span><span class="op">$</span><span class="va">dteday</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">selected_days</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">i</span></span>
<span><span class="op">}</span></span>
<span><span class="va">env</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">env</span><span class="op">)</span></span></code></pre></div>
<p>We create the anchor by encoding the different days as dummy
variables.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Anchor variable days</span></span>
<span><span class="va">anchor</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span> <span class="op">~</span> <span class="va">dteday</span> <span class="op">-</span> <span class="fl">1</span>, data <span class="op">=</span> <span class="va">dframe</span><span class="op">)</span></span></code></pre></div>
<p>Estimation of Anchor Random forest with
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Œ≥</mi><mo>=</mo><mn>2</mn></mrow><annotation encoding="application/x-tex">\gamma = 2</annotation></semantics></math>.
Here we use <code>env</code> as an encoding of the five groups and
estimate 100 trees for each of the left out environment.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://www.markus-ulmer.ch/SDModels/" class="external-link">SDModels</a></span><span class="op">)</span></span>
<span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/SDForest.html">SDForest</a></span><span class="op">(</span><span class="va">cnt</span> <span class="op">~</span> <span class="va">temp</span> <span class="op">+</span> <span class="va">atemp</span> <span class="op">+</span> <span class="va">hum</span> <span class="op">+</span> <span class="va">windspeed</span>, <span class="va">dframe</span>, gamma <span class="op">=</span> <span class="va">gamma</span>,</span>
<span>                Q_type <span class="op">=</span> <span class="st">'no_deconfounding'</span>, nTree_leave_out <span class="op">=</span> <span class="fl">100</span>, A <span class="op">=</span> <span class="va">anchor</span>,</span>
<span>                envs <span class="op">=</span> <span class="va">env</span>, mc.cores <span class="op">=</span> <span class="fl">100</span>, cp <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span></code></pre></div>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0">
<div id="ref-Buhlmann2020InvarianceRobustness" class="csl-entry">
B√ºhlmann, Peter. 2020. <span>‚Äú<span class="nocase">Invariance, Causality
and Robustness</span>.‚Äù</span> <em>Statistical Science</em> 35 (3). <a href="https://doi.org/10.1214/19-STS721" class="external-link">https://doi.org/10.1214/19-STS721</a>.
</div>
<div id="ref-londschien2025domain" class="csl-entry">
Londschien, Malte, Manuel Burger, Gunnar R√§tsch, and Peter B√ºhlmann.
2025. <span>‚ÄúDomain Generalization and Adaptation in Intensive Care with
Anchor Regression.‚Äù</span> <a href="https://arxiv.org/abs/2507.21783" class="external-link">https://arxiv.org/abs/2507.21783</a>.
</div>
<div id="ref-UCI" class="csl-entry">
Markelle Kelly, Kolby Nottingham, Rachel Longjohn. 2017. <span>‚ÄúThe UCI
Machine Learning Repository.‚Äù</span> <a href="https://archive.ics.uci.edu" class="external-link">https://archive.ics.uci.edu</a>.
</div>
<div id="ref-Rothenhausler2021AnchorCausality" class="csl-entry">
Rothenh√§usler, Dominik, Nicolai Meinshausen, Peter B√ºhlmann, and Jonas
Peters. 2021. <span>‚Äú<span>Anchor Regression: Heterogeneous Data Meet
Causality</span>.‚Äù</span> <em>Journal of the Royal Statistical Society
Series B: Statistical Methodology</em> 83 (2): 215‚Äì46. <a href="https://doi.org/10.1111/rssb.12398" class="external-link">https://doi.org/10.1111/rssb.12398</a>.
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by <a href="https://www.markus-ulmer.ch" class="external-link">Markus Ulmer</a>, Cyrill Scheidegger.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

      </footer>
</div>






  </body>
</html>
